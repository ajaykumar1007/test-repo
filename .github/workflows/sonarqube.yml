name: Build

on:
  push:
    branches:
      - main # Replace with the name of your main branch
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    env:
      BACKBLAZE_APP_ID: ${{ secrets.B2_APPKEY_ID }}
      BACKBLAZE_APP_KEY: ${{ secrets.B2_APPKEY }}
      BACKBLAZE_B2BUCKET: 'b2://test-repo-new'
      BACKBLAZE_B2_BUCKET_ID: '5a076c2bfdd7aab381ae0913'
      CURRENT_GITHUB_BRANCH: ${{ github.ref }}
      TIME: $(date +'%Y-%m-%d')
      GITHUB_REPOSITORY: ${{ github.repository }}
      BACKUP_DIR: 'backups'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      ##############################
      # Part 1: SonarQube Scan ####
      ##############################
      - name: set SonarQube project
        run: |
          echo "sonar.projectKey=${{ env.GITHUB_REPOSITORY}}" > sonar-project.properties
          sleep 20

      - uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      ##############################
      # Part 2: Backups Backblaze ###
      ##############################

      # Create archive of the branch
      - name: Create backup archive of branch
        run: tar cpzf "${GITHUB_REPOSITORY/\//-}-${CURRENT_GITHUB_BRANCH//\//}.zip" *

      # Display the list of files in the directory
      - name: List files in directory
        run: ls -a

      # Create a backup directory and move the archive file into it
      - name: Create backup directory and move archive
        run: |
          mkdir -p $BACKUP_DIR
          mv "${GITHUB_REPOSITORY/\//-}-${CURRENT_GITHUB_BRANCH//\//}.zip" $BACKUP_DIR/

      # Copy backups to BackBlaze
      - name: Copy archive to B2
        id: backups
        uses: PEER-Inc/backblaze-b2-custom-action@main
        with:
          B2_BUCKET: $BACKBLAZE_B2BUCKET
          B2_APPKEY_ID: $BACKBLAZE_APP_ID
          B2_APPKEY: $BACKBLAZE_APP_KEY
          SOURCE_DIR: $BACKUP_DIR
